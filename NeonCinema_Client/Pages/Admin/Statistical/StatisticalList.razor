@page "/statistics"
@using NeonCinema_Application.DataTransferObject.Statistics
@using NeonCinema_Client.Data.IServices.Statistics
@using NeonCinema_Client.Data.Services.StatisticService
@inject IJSRuntime JSRuntime
@inject IStatisticsService StatisticsService
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="js/chart.js"></script>

<PageTitle>Thống Kê Doanh Thu</PageTitle>
<h2 class="d-flex justify-content-center align-content-center m-auto mt-5">Thống kê</h2>
<div class="container-fluid mt-5">
    <!-- Tổng quan -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5>Doanh thu trong ngày</h5>
                    <h3>@currentDayRevenue.ToString("N0") VND</h3>
                    <p>@DateTime.Now.ToString("dd-MM-yyyy")</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5>Khách hàng mới</h5>
                    <h3>@statistics?.NewCustomers</h3>
                    <p>@DateTime.Now.ToString("dd-MM-yyyy")</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5>Tổng vé</h5>
                    <h3>@statistics?.TotalTickets</h3>
                    <p>@startDate.ToString("dd-MM-yyyy") | @endDate.ToString("dd-MM-yyyy")</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5>Tổng doanh thu</h5>
                    <h3>@statistics?.TotalRevenue.ToString("N0") VND</h3>
                    <p>@startDate.ToString("dd-MM-yyyy") | @endDate.ToString("dd-MM-yyyy")</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bộ lọc -->
    <div class="row mb-4 filter">
        <div class="col-md-3">
            <label for="startDate">Ngày bắt đầu</label>
            <input type="date" id="startDate" class="form-control" @bind="startDate" />
        </div>
        <div class="col-md-3">
            <label for="endDate">Ngày kết thúc</label>
            <input type="date" id="endDate" class="form-control" @bind="endDate" />
        </div>
        <div class="col-md-3">
            <label for="filterTime">Lọc theo thời gian</label>
            <select id="filterTime" class="form-control" @bind="filterTime">
                <option value="Year">Lọc Theo Năm</option>
                <option value="Month">Lọc Theo Tháng</option>
                <option value="Week">Lọc Theo Tuần</option>
            </select>
        </div>
        <div class="col-md-3 d-flex align-items-end">
            <button class="btn btn-primary w-100" @onclick="FetchStatistics">Chấp nhận</button>
        </div>
    </div>

    <!-- Biểu đồ doanh thu -->
    <div class="row chart-section">
        <div class="col-md-12">
            <h5>Biểu đồ doanh thu</h5>
            <canvas id="revenueChart"></canvas>
        </div>
    </div>
    <!-- Biểu đồ doanh thu theo phim -->
    <div class="row mt-5 chart-section">
        <div class="col-md-12">
            <h5>Biểu đồ doanh thu theo phim</h5>
            <canvas id="movieChart"></canvas>
        </div>
    </div>

    <!-- Biểu đồ doanh thu theo combo -->
    <div class="row mt-5 chart-section">
        <div class="col-md-12">
            <h5>Biểu đồ doanh thu theo combo</h5>
            <canvas id="comboChart"></canvas>
        </div>
    </div>

</div>


  
@code {
    private DateTime startDate = new DateTime(2024, 11, 1);
    private DateTime endDate = new DateTime(2024, 12, 30);
    private RevenueStatisticsDTO statistics;
    private List<MovieStatisticsDTO> movieStatistics = new();
    private List<ComboStatisticsDTO> comboStatistics = new();
    private string filterTime = "Year"; // Mặc định lọc theo năm
    private decimal currentDayRevenue = 0;

    protected override async Task OnInitializedAsync()
    {
        await FetchStatistics();
    }

    private async Task FetchStatistics()
    {
        // Xử lý bộ lọc thời gian
        switch (filterTime)
        {
            case "Year":
                startDate = new DateTime(DateTime.Now.Year, 1, 1);
                endDate = new DateTime(DateTime.Now.Year, 12, 31);
                break;
            case "Month":
                startDate = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1);
                endDate = startDate.AddMonths(1).AddDays(-1);
                break;
            case "Week":
                int diff = (7 + (DateTime.Now.DayOfWeek - DayOfWeek.Monday)) % 7;
                startDate = DateTime.Now.AddDays(-1 * diff).Date;
                endDate = startDate.AddDays(6);
                break;
        }

        statistics = await StatisticsService.GetRevenueStatisticsAsync(startDate, endDate);
        movieStatistics = await StatisticsService.GetMovieStatisticsAsync(startDate, endDate);
        comboStatistics = await StatisticsService.GetComboStatisticsAsync(startDate, endDate);

        if (statistics != null)
        {
            currentDayRevenue = statistics.RevenueChart
                .FirstOrDefault(x => x.Date.Date == DateTime.Now.Date)?.Revenue ?? 0;


            await JSRuntime.InvokeVoidAsync("renderRevenueChart", statistics.RevenueChart);
          
        }
        await JSRuntime.InvokeVoidAsync("renderMovieChart", movieStatistics);
        await JSRuntime.InvokeVoidAsync("renderComboChart", comboStatistics);
    }
}
<style>
    body {
        background-color: #f8f9fa;
    }
    .container-fluid {
        margin-top: 20px;
    }

    .card {
        border: 1px solid #ddd;
        box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);
        border-radius: 10px;
    }

    .filter {
        border: 1px solid #ddd; /* Đường viền */
        border-radius: 10px; /* Bo góc */
        padding: 20px; /* Khoảng cách bên trong */
        background-color: white; /* Màu nền nhạt */
        box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1); /* Hiệu ứng đổ bóng */
        margin-left: 1px;
        margin-right: 1px;
    }
    .card-body h5 {
        font-weight: revert;
        font-size: 1.2rem;
        margin-bottom: 10px;
    }

    .card-body h3 {
        font-size: 1.5rem;
        font-weight: bold;
        color: #007bff;
    }

    .chart-section {
        border: 1px solid #ddd; /* Đường viền */
        border-radius: 10px; /* Bo góc */
        padding: 20px; /* Khoảng cách bên trong */
        background-color: white; /* Màu nền nhạt */
        box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1); /* Hiệu ứng đổ bóng */
        margin-bottom: 20px; /* Khoảng cách giữa các biểu đồ */
        margin-left: 1px;
        margin-right: 1px;
    }

    canvas {
        width: 100%;
        height: 400px;
    }

  
    #comboChart {
        max-width: 600px; /* Chiều rộng tối đa */
        max-height: 400px; /* Chiều cao tối đa */
        margin: 10px auto; /* Canh giữa và thêm khoảng cách */
        display: block;
    }

</style>