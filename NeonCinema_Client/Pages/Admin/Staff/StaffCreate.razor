@page "/staff-create"
@using Microsoft.AspNetCore.Http;
@using NeonCinema_Application.DataTransferObject.User
@using NeonCinema_Client.Data.IServices.User
@layout LayoutAdmin
@using System.Text.Json
@using NeonCinema_Domain.Enum
@inject IUserServices UserService
@inject NavigationManager _navigation
@inject HttpClient _http

<EditForm Model="request">
    <div class="container-fluid mt-5">
        <h2 class="text-center mb-4 font-weight-bold">Thêm nhân viên mới</h2>
        <div class="row justify-content-center">
            <div class="col-md-3 text-center mb-4 mt-5">
                <img src="/images/Client/cam.jpg" alt="Profile" class="rounded-circle img-fluid profile-pic">
            </div>
            <div class="col-md-9" style="margin-top:10px;">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="name" class="font-weight-bold">Họ và tên</label>
                            <input type="text" class="form-control" id="name" @bind-value="request.FullName"/>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="phone" class="font-weight-bold">Số điện thoại</label>
                            <input type="text" class="form-control" id="phone" @bind-value="request.PhoneNumber">
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="email" class="font-weight-bold">Email</label>
                            <input type="email" class="form-control" id="email" @bind-value="request.Email">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="dob" class="font-weight-bold">Ngày sinh</label>
                            <input type="date" class="form-control" id="dateofbirth" @bind-value="request.DateOrBriht">
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="images" class="font-weight-bold">Images</label>
                            <InputFile OnChange="HandleSelected" />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="pass" class="font-weight-bold">Mật khẩu</label>
                            <input type="text" class="form-control" id="pass" @bind-value="request.PassWord">
                        </div>
                    </div>
                </div>
               

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Giới tính</label>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" id="genderMale" name="gender" @bind="@request.Gender"  />
                                <label class="form-check-label" for="genderMale" style="margin-left: 0.5rem; margin-top: 5px">Nam</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" id="genderFemale" name="gender" @bind="@request.Gender"/>
                                <label class="form-check-label" for="genderFemale" style="margin-left: 0.5rem; margin-top: 5px">Nữ</label>
                            </div>
                        </div>

                    </div>
                @*     <div class="col-md-6">
                        <div class="form-group">
                            <label>Trạng thái</label>
                            <select class="form-select" @bind="request.Status">
                                <option value="@(EntityStatus.Active)">Đang hoạt động</option>
                                <option value="@(EntityStatus.Inactive)">Không hoạt động</option>
                            </select>
                        </div>
                    </div> *@
                </div>

                <div class="form-group">
                    <label for="Description" class="font-weight-bold">Mô tả</label>
                    <textarea class="form-control" id="Description" rows="3" @bind="request.Adderss"></textarea>
                </div>

                <div class="text-center">
                    <button type="button" @onclick="HandleSubmit" class="btn btn-success btn-lg">Thêm</button>
                </div>
            </div>
        </div>
    </div>
</EditForm>

@code {
    private UserCreateRequest request = new UserCreateRequest();
    private IBrowserFile selectedFile;

    private async Task HandleSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
    }

    private async Task HandleSubmit()
    {
        try
        {
            if (selectedFile == null)
            {
                return;
            }

            var content = new MultipartFormDataContent();
            var fileContent = new StreamContent(selectedFile.OpenReadStream(maxAllowedSize: 1024 * 1024 * 15));
            fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(selectedFile.ContentType);

            content.Add(fileContent, "file", selectedFile.Name);
            var response = await _http.PostAsync("https://localhost:7211/api/UploadImages/upload-image", content);

            if (response.IsSuccessStatusCode)
            {
                var jsonResponse = await response.Content.ReadAsStringAsync();
                var jsonDoc = JsonDocument.Parse(jsonResponse);
                var fileUrl = jsonDoc.RootElement.GetProperty("fileUrl").GetString();
                var fileName = Path.GetFileName(fileUrl);
                request.Images = fileName;

                Console.WriteLine($"Upload thành công. Tên file: {fileName}");
            }
            else
            {
                Console.WriteLine($"Lỗi upload ảnh. Status code: {response.StatusCode}");
                return;
            }

            var userResponse = await UserService.CreateUser(request);
            if (userResponse.IsSuccessStatusCode)
            {
                _navigation.NavigateTo("/staff");
            }
            else
            {
                var errorContent = await userResponse.Content.ReadAsStringAsync();
                Console.WriteLine($"Có lỗi xảy ra khi tạo nhân viên: {errorContent}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Lỗi: {ex.Message}");
            Console.WriteLine($"Chi tiết ngoại lệ: {ex.StackTrace}");
        }
    }
}

<style>
    body {
        background-color: #f4f4f9;
    }

    .card {
        border-radius: 10px;
        background-color: white;
        max-width: 1000px;
        margin: auto;
    }

    h2 {
        font-family: 'Arial', sans-serif;
        color: #333;
    }

    .profile-pic {
        width: 200px;
        height: 200px;
        object-fit: cover;
        border: 3px solid #eaeaea;
        margin-left: -15px;
    }

    label {
        font-size: 14px;
        color: #555;
    }

    input, select, textarea {
        border-radius: 5px;
        border: 1px solid #ccc;
        padding: 10px;
        margin-left: -20px;
    }

    .form-control:focus {
        border-color: #007bff;
        box-shadow: 0 0 5px rgba(0, 123, 255, 0.25);
    }

    textarea {
        resize: none;
    }

    .btn-success {
        background-color: #007bff;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        font-size: 16px;
    }

        .btn-success:hover {
            background-color: #0056b3;
        }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-check {
        margin-right: 15px;
    }
</style>
