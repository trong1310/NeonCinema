@page "/addroom"
@using NeonCinema_Application.DataTransferObject.Cinemas
@using NeonCinema_Application.DataTransferObject.Room
@using NeonCinema_Client.Data.IServices.IRoom
@using NeonCinema_Domain.Enum
@inject IRoomService RoomService
@layout LayoutAdmin
@inject NavigationManager Navigation
@attribute [Authorize(Roles = "Admin")]
@layout LayoutAdmin
<EditForm Model="request" OnValidSubmit="AddRoom">
    <DataAnnotationsValidator />
    
    <div class="add-room-container">
        <h3 class="title">Thêm phòng chiếu</h3>

        <div class="form">
            <div class="form-group">
                <label for="roomName">Tên phòng</label>
                <input id="roomName" class="form-control" @bind="request.Name" />
                <ValidationMessage For="@(() => request.Name)" />
                @if (!string.IsNullOrWhiteSpace(errorMessage))
                {
                    <div class="text-danger">@errorMessage</div>
                }
            </div>

            <div class="form-group">
                <label for="rowNumber">Số hàng</label>
                <input id="rowNumber" type="number" class="form-control" @bind="request.RowNumber" />
               
                <ValidationMessage For="@(() => request.RowNumber)" />
            </div>

            <div class="form-group">
                <label for="columnNumber">Số cột</label>
                <input id="columnNumber" type="number" class="form-control" @bind="request.ColumnNumber" />
               
                <ValidationMessage For="@(() => request.ColumnNumber)" />
            </div>

           @*  <div class="form-group">
                <label for="cinema">Chọn rạp</label>
                <select id="cinema" class="form-control" @bind="request.CinemasId" >
                    <option value="@Guid.Empty">-Chọn rạp-</option>
                    @foreach (var cinema in cinemas )
                    {
                        <option value="@cinema.ID">@cinema.Name</option>
                    }
                </select>
                <ValidationSummary />
                <ValidationMessage For="@(() => request.CinemasId)" />
               
                
            </div> *@
        </div>

        <div class="button-group">
            <button class="btn btn-success" type="submit">Thêm</button>
            <button class="btn btn-secondary" @onclick="Cancel">Hủy</button>
        </div>
    </div>


</EditForm>


   


@code {
    
    private List<CinemasDTO> cinemas = new List<CinemasDTO>();
    private string errorMessage;

    private RoomCreateRequest request = new RoomCreateRequest
        {
            Status = EntityStatus.Active ,
            CinemasId = Guid.Parse("8fb86c77-213f-4316-8a7a-43fee795514e")
        };
    private List<string> selectedSeats = new List<string>();
    
    private void SelectSeat(int row, int col)
    {
        string seatLabel = $"{(char)('A' + row)}{col + 1}";
        if (selectedSeats.Contains(seatLabel))
        {
            selectedSeats.Remove(seatLabel);
        }
        else
        {
            selectedSeats.Add(seatLabel);
        }
    }
   
    protected override async Task OnInitializedAsync()
    {
        cinemas = await RoomService.GetAllCinemas();
    }
    
    private async Task AddRoom()
    {
        if (request.CinemasId == Guid.Empty)
        {
            errorMessage = "Vui lòng chọn rạp.";
            StateHasChanged(); 
            return;
        }
        var normalizedName = NormalizeName(request.Name);
        if (await IsRoomNameDuplicate(normalizedName))
        {
            errorMessage = "Tên phòng đã tồn tại. Vui lòng chọn tên khác.";
            StateHasChanged();
            return;
        }
        errorMessage = null;
        StateHasChanged();
        await RoomService.CreateRoom(request);
        Navigation.NavigateTo("/listroom");
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/listroom");
    }
    private string NormalizeName(string name)
    {
        return string.Join(" ", name.Split(new[] { ' ' }, StringSplitOptions.RemoveEmptyEntries)).Trim();
    }

    private async Task<bool> IsRoomNameDuplicate(string name)
    {
        var normalizedName = NormalizeName(name).ToLowerInvariant(); 
        var existingRooms = await RoomService.GetAllRooms();
        return existingRooms.Any(r => NormalizeName(r.Name).ToLowerInvariant() == normalizedName);
    }
    
}
<style>
    .add-room-container {
        max-width: 600px;
        margin: 30px auto;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .title {
        text-align: center;
        margin-bottom: 20px;
        font-size: 24px;
        font-weight: bold;
    }

    .text-danger {
        color: #dc3545; 
        font-size: 0.875rem; 
        margin-top: 5px;
    }
    .form {
        display: grid;
        gap: 15px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    label {
        margin-bottom: 5px;
        font-weight: 600;
    }

    .form-control {
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #ccc;
    }

    .button-group {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
    }

    .btn {
        padding: 8px 16px;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
    }

    .btn-success {
        background-color: #28a745;
        color: white;
        border: none;
    }

    .btn-secondary {
        background-color: #6c757d;
        color: white;
        border: none;
    }

    .btn-success:hover {
        background-color: #218838;
    }

    .btn-secondary:hover {
        background-color: #5a6268;
    }
    /* transition.css */
    .fade-enter-active,
    .fade-leave-active {
        transition: opacity 0.5s ease-in-out;
    }

    .fade-enter,
    .fade-leave-to {
        opacity: 0;
    }

</style>
